# Strategy 6 VCB（波动率压缩突破）策略使用手册

## 目录

1. [策略概述](#策略概述)
2. [系统架构](#系统架构)
3. [文件结构说明](#文件结构说明)
4. [核心函数详解](#核心函数详解)
5. [使用指南](#使用指南)
6. [执行流程详解](#执行流程详解)
7. [配置参数说明](#配置参数说明)
8. [常见问题](#常见问题)

---

## 策略概述

**VCB（Volatility Compression Breakout）策略**是一个基于波动率压缩突破的量化交易策略。

### 核心思想

策略不是在**预测方向**，而是在**等待结构性失衡**。当一个币种在短周期内出现真实波动率显著低于中周期背景波动率，并且价格被"压"在狭窄区间内时，只要价格脱离这个区间，行情往往不是0.2%，而是1%-3%的连续运动。

### 策略特点

- **市场扫描**：自动扫描300+币种，寻找压缩机会
- **生产者/消费者架构**：分离扫描和监控逻辑
- **多币种支持**：可同时监控和交易多个币种
- **自动风险管理**：内置止损、止盈和移动止损机制

---

## 系统架构

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    VCBMarketMonitor                       │
│                  (主控制器，协调所有模块)                    │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┴─────────────────┐
        │                                   │
┌───────▼────────┐                  ┌───────▼────────┐
│ Compression    │                  │ Breakout       │
│ Scanner        │                  │ Watcher        │
│ (生产者线程)    │                  │ (消费者线程)    │
└───────┬────────┘                  └───────┬────────┘
        │                                   │
        │ 发现压缩事件                        │ 检测突破信号
        │                                   │
        └───────────────┬───────────────────┘
                        │
                ┌───────▼────────┐
                │  VCBStrategy   │
                │  (压缩池管理)    │
                └───────┬────────┘
                        │
                ┌───────▼────────┐
                │ Strategy6Trader │
                │  (交易执行)      │
                └────────────────┘
```

### 工作流程

1. **CompressionScanner（生产者）**：定期扫描市场，发现压缩事件 → 放入压缩池
2. **Compression Pool（中间态）**：存储所有活跃的压缩事件，自动清理过期事件
3. **BreakoutWatcher（消费者）**：监控压缩池中的币种，检测突破 → 触发交易
4. **Strategy6Trader（执行器）**：执行实际交易操作

---

## 文件结构说明

### 核心策略文件

#### 1. `strategy_6.py` - 核心策略类

**作用**：实现VCB策略的核心逻辑，包括压缩检测、突破检测和压缩池管理。

**主要类**：

- **`CompressionEvent`**：压缩事件类
  - 存储压缩事件的元数据（开始时间、ATR比率、布林带参数等）
  - 管理压缩事件的TTL（存活时间）
  - 判断压缩事件是否过期或失效

- **`VCBStrategy`**：VCB策略主类
  - 管理压缩池（Compression Pool）
  - 提供压缩检测和突破检测方法

**主要函数**：

| 函数名 | 作用 | 调用时机 |
|--------|------|----------|
| `detect_compression()` | 检测单个币种的波动率压缩 | 市场扫描时 |
| `detect_breakout()` | 检测压缩池中币种的突破信号 | 每根K线检查时 |
| `cleanup_compression_pool()` | 清理过期或失效的压缩事件 | 定期清理时 |
| `get_strategy_details()` | 获取策略详细信息（用于调试） | 需要查看详情时 |

#### 2. `compression_scanner.py` - 压缩扫描器（生产者）

**作用**：扫描整个市场，寻找压缩事件。

**主要类**：

- **`CompressionScanner`**：压缩扫描器类

**主要函数**：

| 函数名 | 作用 | 调用时机 |
|--------|------|----------|
| `scan_market()` | 扫描整个市场，寻找压缩事件 | 每5分钟（可配置） |
| `_scan_single_symbol()` | 扫描单个币种 | 并行扫描时 |
| `_get_symbols_to_scan()` | 获取需要扫描的币种列表 | 扫描前 |
| `get_scan_stats()` | 获取扫描统计信息 | 查看统计时 |

#### 3. `breakout_watcher.py` - 突破监控器（消费者）

**作用**：监控压缩池中的币种，检测突破信号。

**主要类**：

- **`BreakoutWatcher`**：突破监控器类

**主要函数**：

| 函数名 | 作用 | 调用时机 |
|--------|------|----------|
| `watch_compression_pool()` | 监控压缩池中的所有币种 | 每根K线 |
| `register_breakout_callback()` | 注册突破信号回调函数 | 初始化时 |
| `_trigger_callbacks()` | 触发所有注册的回调函数 | 发现突破时 |
| `get_watch_stats()` | 获取监控统计信息 | 查看统计时 |

#### 4. `strategy_6_market_monitor.py` - 市场监控主程序

**作用**：主控制器，协调所有模块，管理整个系统。

**主要类**：

- **`VCBMarketMonitor`**：市场监控器主类

**主要函数**：

| 函数名 | 作用 | 调用时机 |
|--------|------|----------|
| `__init__()` | 初始化所有组件 | 程序启动时 |
| `start()` | 启动监控系统 | 用户调用时 |
| `stop()` | 停止监控系统 | 用户停止或程序退出时 |
| `run()` | 运行监控系统（阻塞） | 主程序入口 |
| `_scan_loop()` | 扫描循环（生产者线程） | 后台线程 |
| `_watch_loop()` | 监控循环（消费者线程） | 后台线程 |
| `_on_breakout()` | 突破信号回调处理 | 发现突破时 |
| `_execute_trade()` | 执行交易 | 突破回调时 |

### 辅助文件

#### 5. `methods/monitor.py` - 单币种监控（保留用于单币种模式）

**作用**：单币种监控实现（类似strategy_1，保留用于特殊场景）。

**主要类**：

- **`Strategy6Monitor`**：单币种监控器

#### 6. `methods/trader.py` - 交易执行器

**作用**：执行实际交易操作。

**主要类**：

- **`Strategy6Trader`**：交易执行器类（继承自BaseTrader）

#### 7. `shared_config.py` - 配置管理

**作用**：管理策略配置参数。

**主要函数**：

| 函数名 | 作用 |
|--------|------|
| `load_config_from_file()` | 从JSON文件加载配置 |
| `get_user_input()` | 获取用户输入参数 |
| `print_final_config()` | 打印最终使用的参数 |

#### 8. `configs/default.json` - 默认配置文件

**作用**：存储默认配置参数。

---

## 核心函数详解

### 1. 压缩检测流程

#### `VCBStrategy.detect_compression()`

**功能**：检测单个币种是否出现波动率压缩。

**执行步骤**：

1. 获取K线数据（需要足够的历史数据）
2. 计算ATR（短期和中期）
   - `ATR_short = ATR(10)`
   - `ATR_mid = ATR(60)`
3. 计算ATR比率：`atr_ratio = ATR_short / ATR_mid`
4. 检查ATR相对收缩：`atr_ratio < 0.5`（可配置）
5. 计算布林带（BB）
   - `BB(20, 2)` - 20周期，2倍标准差
6. 计算布林带宽度：`bb_width = (upper - lower) / middle`
7. 检查布林带宽度收缩：`bb_width < 0.7 × bb_width_60_mean`
8. 如果两个条件都满足，创建压缩事件并放入压缩池

**返回值**：
- `CompressionEvent`：如果检测到压缩
- `None`：如果未检测到压缩

### 2. 突破检测流程

#### `VCBStrategy.detect_breakout()`

**功能**：检测压缩池中币种的突破信号。

**执行步骤**：

1. 检查币种是否在压缩池中
2. 获取最新K线数据
3. 计算成交量均线：`MA(Volume, 20)`
4. 检查成交量放大：`current_volume > multiplier × avg_volume`
5. 检查价格突破：
   - 做多：`close > BB_upper`
   - 做空：`close < BB_lower`
6. 如果价格突破且成交量放大，返回突破信号
7. 从压缩池中移除该币种（突破后不再监控）

**返回值**：
- `(1, details)`：做多突破信号
- `(-1, details)`：做空突破信号
- `(0, {})`：无突破信号

### 3. 压缩池管理

#### `VCBStrategy.cleanup_compression_pool()`

**功能**：清理过期或失效的压缩事件。

**清理条件**：

1. **TTL过期**：压缩事件存活时间超过配置的K线数量
2. **ATR比率回升**：当前ATR比率 > 0.7（压缩失效）

**执行频率**：
- 每次市场扫描后
- 每次突破检测后

### 4. 市场扫描流程

#### `CompressionScanner.scan_market()`

**功能**：扫描整个市场，寻找压缩事件。

**执行步骤**：

1. 获取符合条件的币种列表（基于24h交易量过滤）
2. 使用线程池并行扫描所有币种
3. 对每个币种调用 `VCBStrategy.detect_compression()`
4. 收集所有新发现的压缩事件
5. 更新扫描统计信息

**并行处理**：
- 默认使用10个线程并行扫描
- 可配置 `max_workers` 参数

### 5. 突破监控流程

#### `BreakoutWatcher.watch_compression_pool()`

**功能**：监控压缩池中的所有币种，检测突破。

**执行步骤**：

1. 获取压缩池中的所有币种列表
2. 对每个币种调用 `VCBStrategy.detect_breakout()`
3. 收集所有突破信号
4. 触发回调函数（通知主控制器）
5. 更新监控统计信息

**执行频率**：
- 每根K线检查一次（1分钟K线 = 每60秒检查一次）

---

## 使用指南

### 1. 环境准备

#### 1.1 安装依赖

确保已安装所有必要的Python包：

```bash
pip install -r requirements.txt
```

#### 1.2 配置API密钥（可选）

如果需要真实交易，在项目根目录创建 `.env` 文件：

```env
OK-ACCESS-KEY=your_api_key
OK-ACCESS-SECRET=your_api_secret
OK-ACCESS-PASSPHRASE=your_passphrase
```

### 2. 配置文件

#### 2.1 默认配置

编辑 `configs/default.json`：

```json
{
  "min_vol_ccy": 10000000,        // 最小24h交易量（USDT）
  "currency": "USDT",             // 交易对货币
  "inst_type": "SWAP",            // 合约类型（SPOT/SWAP）
  "scan_interval_minutes": 5,     // 市场扫描间隔（分钟）
  "max_workers": 10,              // 并行扫描线程数
  "bar": "1m",                    // K线周期
  "atr_short_period": 10,         // 短期ATR周期
  "atr_mid_period": 60,           // 中期ATR周期
  "atr_ratio_threshold": 0.5,     // ATR比率阈值
  "bb_period": 20,                // 布林带周期
  "bb_std": 2,                    // 布林带标准差倍数
  "bb_width_ratio": 0.7,          // 布林带宽度收缩比率
  "volume_period": 20,            // 成交量均线周期
  "volume_multiplier": 1.0,        // 成交量放大倍数
  "ttl_bars": 30,                 // 压缩事件TTL（K线数量）
  "trailing_stop_pct": 1.0,       // 移动止损百分比
  "stop_loss_atr_multiplier": 0.8, // 止损ATR倍数
  "take_profit_r": 2.0,           // 止盈R倍数
  "trade": false,                 // 是否真实交易
  "trade_amount": 10.0,           // 每次交易金额（USDT）
  "trade_mode": 3,                // 交易模式（1=现货, 2=全仓, 3=逐仓）
  "leverage": 3                   // 杠杆倍数
}
```

### 3. 启动系统

#### 3.1 使用默认配置

```bash
cd /Users/zijund/Code/crypto_scanner
python strategies/strategy_6_vcb/strategy_6_market_monitor.py
```

#### 3.2 使用自定义配置文件

```bash
python strategies/strategy_6_vcb/strategy_6_market_monitor.py --config configs/my_config.json
```

### 4. 停止系统

按 `Ctrl+C` 停止系统，系统会：
1. 停止所有线程
2. 打印统计信息
3. 安全退出

---

## 执行流程详解

### 启动流程

```
1. 用户运行 strategy_6_market_monitor.py
   ↓
2. main() 函数执行
   ↓
3. 加载配置文件（如果有）
   ↓
4. 创建 VCBMarketMonitor 实例
   ↓
5. VCBMarketMonitor.__init__() 执行：
   - 初始化 OKXClient
   - 创建 VCBStrategy 实例（共享压缩池）
   - 创建 CompressionScanner 实例（生产者）
   - 创建 BreakoutWatcher 实例（消费者）
   - 注册突破回调函数
   - 初始化交易器（如果启用真实交易）
   ↓
6. monitor.run() 执行
   ↓
7. monitor.start() 执行：
   - 打印启动信息
   - 启动扫描线程（生产者）
   - 启动监控线程（消费者）
   ↓
8. 系统进入运行状态
```

### 运行时流程

#### 生产者线程（扫描循环）

```
_scan_loop() 开始执行
   ↓
每 scan_interval_minutes 分钟执行一次：
   ↓
1. CompressionScanner.scan_market() 执行
   ↓
2. _get_symbols_to_scan() 获取币种列表
   ↓
3. 使用线程池并行扫描：
   - 对每个币种调用 _scan_single_symbol()
   - _scan_single_symbol() 调用 VCBStrategy.detect_compression()
   ↓
4. VCBStrategy.detect_compression() 执行：
   - 获取K线数据
   - 计算ATR和布林带
   - 检查压缩条件
   - 如果满足，创建 CompressionEvent 并放入压缩池
   ↓
5. VCBStrategy.cleanup_compression_pool() 清理过期事件
   ↓
6. 等待下次扫描时间
```

#### 消费者线程（监控循环）

```
_watch_loop() 开始执行
   ↓
每根K线执行一次（1分钟K线 = 每60秒）：
   ↓
1. BreakoutWatcher.watch_compression_pool() 执行
   ↓
2. 获取压缩池中的所有币种
   ↓
3. 对每个币种调用 VCBStrategy.detect_breakout()
   ↓
4. VCBStrategy.detect_breakout() 执行：
   - 检查币种是否在压缩池中
   - 获取最新K线数据
   - 计算成交量均线
   - 检查价格突破和成交量放大
   - 如果突破，从压缩池中移除币种
   ↓
5. 如果发现突破，触发回调：
   - BreakoutWatcher._trigger_callbacks()
   - 调用 VCBMarketMonitor._on_breakout()
   ↓
6. VCBMarketMonitor._on_breakout() 执行：
   - 调用 _execute_trade()
   ↓
7. VCBMarketMonitor._execute_trade() 执行：
   - 记录模拟交易
   - 更新持仓信息
   - 如果启用真实交易，调用 Strategy6Trader.execute_trade()
   ↓
8. VCBStrategy.cleanup_compression_pool() 清理过期事件
   ↓
9. 等待下次K线时间
```

### 交易执行流程

```
突破信号触发
   ↓
_on_breakout(symbol, signal, details) 执行
   ↓
_execute_trade(symbol, signal, price, details) 执行
   ↓
1. 确定交易动作：
   - signal == 1 → "LONG_OPEN"（做多）
   - signal == -1 → "SHORT_OPEN"（做空）
   ↓
2. 更新持仓信息：
   - 如果币种已有持仓，先平仓再开新仓
   - 记录入场价格、时间等
   ↓
3. 记录模拟交易日志
   ↓
4. 如果启用真实交易：
   - Strategy6Trader.execute_trade(action, symbol, price)
   - 根据action执行相应的交易操作
   ↓
5. 交易完成
```

### 停止流程

```
用户按 Ctrl+C
   ↓
KeyboardInterrupt 异常触发
   ↓
monitor.run() 的 finally 块执行
   ↓
monitor.stop() 执行：
   ↓
1. 设置 running = False
   ↓
2. 等待所有线程结束（最多等待5秒）
   ↓
3. 获取并打印统计信息：
   - CompressionScanner.get_scan_stats()
   - BreakoutWatcher.get_watch_stats()
   ↓
4. 打印最终状态：
   - 压缩池大小
   - 持仓数量
   ↓
5. 程序退出
```

---

## 配置参数说明

### 扫描参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `min_vol_ccy` | float | 10000000 | 最小24小时交易量（USDT），用于过滤低流动性币种 |
| `currency` | string | "USDT" | 交易对货币 |
| `inst_type` | string | "SWAP" | 合约类型：SPOT（现货）或SWAP（永续合约） |
| `scan_interval_minutes` | int | 5 | 市场扫描间隔（分钟） |
| `max_workers` | int | 10 | 并行扫描的最大线程数 |

### 压缩检测参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `bar` | string | "1m" | K线周期（1m/5m/15m等） |
| `atr_short_period` | int | 10 | 短期ATR周期 |
| `atr_mid_period` | int | 60 | 中期ATR周期 |
| `atr_ratio_threshold` | float | 0.5 | ATR比率阈值，ATR_short/ATR_mid < 此值时认为压缩 |
| `bb_period` | int | 20 | 布林带周期 |
| `bb_std` | int | 2 | 布林带标准差倍数 |
| `bb_width_ratio` | float | 0.7 | 布林带宽度收缩比率 |
| `ttl_bars` | int | 30 | 压缩事件TTL（K线数量），超过此数量未突破则失效 |

### 突破检测参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `volume_period` | int | 20 | 成交量均线周期 |
| `volume_multiplier` | float | 1.0 | 成交量放大倍数，当前成交量 > 此值 × 均量时认为放量 |

### 风险管理参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `trailing_stop_pct` | float | 1.0 | 移动止损百分比 |
| `stop_loss_atr_multiplier` | float | 0.8 | 止损ATR倍数 |
| `take_profit_r` | float | 2.0 | 止盈R倍数（基于风险倍数） |

### 交易参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `trade` | bool | false | 是否启用真实交易 |
| `trade_amount` | float | 10.0 | 每次交易金额（USDT） |
| `trade_mode` | int | 3 | 交易模式：1=现货，2=全仓杠杆，3=逐仓杠杆 |
| `leverage` | int | 3 | 杠杆倍数（仅杠杆模式有效） |

---

## 常见问题

### Q1: 系统启动后没有发现压缩事件？

**可能原因**：
1. 市场当前没有符合条件的压缩
2. `min_vol_ccy` 设置过高，过滤掉了太多币种
3. `atr_ratio_threshold` 设置过严格

**解决方法**：
- 降低 `min_vol_ccy` 值
- 适当放宽 `atr_ratio_threshold`（如改为0.6）
- 等待市场出现压缩机会

### Q2: 发现压缩但没有突破？

**可能原因**：
1. 压缩事件TTL过期
2. ATR比率回升，压缩失效
3. 突破条件未满足（价格未突破或成交量未放大）

**解决方法**：
- 检查 `ttl_bars` 设置是否合理
- 检查 `volume_multiplier` 是否过严格
- 查看日志了解具体原因

### Q3: 如何调整扫描频率？

修改配置文件中的 `scan_interval_minutes` 参数：
- 更频繁扫描：设置为 3（每3分钟扫描一次）
- 更少扫描：设置为 10（每10分钟扫描一次）

注意：过于频繁的扫描可能触发API限流。

### Q4: 如何查看当前压缩池状态？

系统会定期打印状态信息，包括：
- 压缩池大小
- 压缩池中的币种列表
- 当前持仓数量

### Q5: 真实交易如何启用？

1. 在 `.env` 文件中配置API密钥
2. 在配置文件中设置 `"trade": true`
3. 配置交易参数（`trade_amount`, `trade_mode`, `leverage`）

**⚠️ 警告**：启用真实交易前请充分测试，确保策略逻辑正确！

### Q6: 如何优化策略参数？

建议步骤：
1. 使用模拟交易模式测试不同参数组合
2. 记录每次交易的收益和风险
3. 分析参数对策略表现的影响
4. 选择最优参数组合后再启用真实交易

### Q7: 系统占用资源过多？

**优化建议**：
1. 降低 `max_workers`（减少并行线程数）
2. 增加 `scan_interval_minutes`（减少扫描频率）
3. 提高 `min_vol_ccy`（减少扫描的币种数量）

### Q8: 如何处理网络错误？

系统已内置错误处理：
- 网络错误时会自动重试
- 单个币种扫描失败不会影响整体运行
- 建议保持稳定的网络连接

---

## 日志说明

### 日志级别

- **INFO**：正常信息（扫描结果、突破信号等）
- **WARNING**：警告信息（单个币种扫描失败等）
- **ERROR**：错误信息（严重错误，需要关注）

### 关键日志示例

```
✅ 发现压缩: BTC-USDT (ATR比率=0.4234)
🚀 突破信号: BTC-USDT 做多 价格=45000.0000, 成交量比率=1.85
[模拟交易] BTC-USDT LONG_OPEN: 价格=45000.0000
[状态] 压缩池: 5 个币种, 持仓: 2 个
```

---

## 技术支持

如有问题，请检查：
1. 日志文件中的错误信息
2. 配置文件是否正确
3. API密钥是否有效（真实交易模式）
4. 网络连接是否正常

---

**版本**：1.0  
**最后更新**：2025年  
**作者**：Zijun Deng

