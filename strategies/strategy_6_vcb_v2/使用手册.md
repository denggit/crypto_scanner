# Strategy 6 VCB（波动率压缩突破）策略使用手册

## 目录

1. [策略概述](#策略概述)
2. [系统架构](#系统架构)
3. [文件结构说明](#文件结构说明)
4. [核心函数详解](#核心函数详解)
5. [使用指南](#使用指南)
6. [执行流程详解](#执行流程详解)
7. [配置参数说明](#配置参数说明)
8. [常见问题](#常见问题)

---

## 策略概述

**VCB（Volatility Compression Breakout）策略 V2.0**是一个基于波动率压缩突破的量化交易策略。

### 核心思想

策略不是在**预测方向**，而是在**等待结构性失衡**。当一个币种在短周期内出现真实波动率显著低于中周期背景波动率，并且价格被"
压"在狭窄区间内时，只要价格脱离这个区间，行情往往不是0.2%，而是1%-3%的连续运动。

### V2.0 核心改进

V2.0 并非推翻原策略，而是一次**工程级纠偏**，核心思想是：

> **不是"看见压缩就赌突破"，而是只交易"质量足够高、值得下注的压缩"。**

**主要改进**：

1. **多时间框架压缩检测**：
   - Level 1（5分钟）：主压缩识别（结构层）
   - Level 2（15分钟）：背景验证（趋势强度、波动率背景、价格结构）
   - Level 3（1分钟）：入场与执行（时机层）

2. **压缩评分系统**：
   - 引入压缩评分（0-100），只交易高质量压缩（评分≥70）
   - 评分维度：ATR相对压缩(30%)、压缩持续时间(25%)、成交量健康度(20%)、价格区间收敛(15%)、均线聚合度(10%)

3. **突破质量评估**：
   - 突破K线必须满足至少3/4个条件：
     - 实体 ≥ 0.4 × ATR(14)
     - 影线短（假突破过滤）
     - 成交量显著高于近期低点
     - 创局部新高/新低

4. **结构验证机制**：
   - 突破后最多允许2根K线的验证期
   - 验证期内判断突破结构是否被否定
   - 结构失败判定：价格回到压缩区间内部

5. **止损逻辑优化**：
   - 使用ATR(20)而不是ATR(60)
   - 结构止损：压缩区间反侧 ± 0.2×ATR
   - ATR止损：1.2 × ATR(20)
   - 取两者中更保守者

### 策略特点

- **市场扫描**：自动扫描300+币种，寻找高质量压缩机会
- **生产者/消费者架构**：分离扫描和监控逻辑
- **多币种支持**：可同时监控和交易多个币种
- **自动风险管理**：内置止损、止盈和移动止损机制
- **质量过滤**：通过压缩评分和突破质量评估，降低假突破率

---

## 系统架构

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    VCBMarketMonitor                       │
│                  (主控制器，协调所有模块)                    │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┴─────────────────┐
        │                                   │
┌───────▼────────┐                  ┌───────▼────────┐
│ Compression    │                  │ Breakout       │
│ Scanner        │                  │ Watcher        │
│ (生产者线程)    │                  │ (消费者线程)    │
└───────┬────────┘                  └───────┬────────┘
        │                                   │
        │ 发现压缩事件                        │ 检测突破信号
        │                                   │
        └───────────────┬───────────────────┘
                        │
                ┌───────▼────────┐
                │  VCBStrategy   │
                │  (压缩池管理)    │
                └───────┬────────┘
                        │
                ┌───────▼────────┐
                │ Strategy6Trader │
                │  (交易执行)      │
                └────────────────┘
```

### 工作流程

1. **CompressionScanner（生产者）**：定期扫描市场，发现压缩事件 → 放入压缩池
2. **Compression Pool（中间态）**：存储所有活跃的压缩事件，自动清理过期事件
3. **BreakoutWatcher（消费者）**：监控压缩池中的币种，检测突破 → 触发交易
4. **Strategy6Trader（执行器）**：执行实际交易操作

---

## 文件结构说明

### 核心策略文件

#### 1. `strategy_6.py` - 核心策略类

**作用**：实现VCB策略的核心逻辑，包括压缩检测、突破检测和压缩池管理。

**主要类**：

- **`CompressionEvent`**：压缩事件类（v2增强）
    - 存储压缩事件的元数据（开始时间、ATR比率、布林带参数等）
    - 管理压缩事件的TTL（存活时间）
    - 判断压缩事件是否过期或失效
    - **v2新增**：压缩评分、突破水平、失效水平、时间框架信息

- **`VCBStrategy`**：VCB策略主类
    - 管理压缩池（Compression Pool）
    - 提供压缩检测和突破检测方法

**主要函数**：

| 函数名 | 作用 | 调用时机 |
|--------|------|----------|
| `detect_compression()` | 检测单个币种的波动率压缩（v2多时间框架） | 市场扫描时 |
| `_calculate_compression_score()` | 计算压缩评分（v2新增） | 压缩检测时 |
| `_validate_15m_compression()` | 15分钟周期验证（v2新增） | 压缩检测时 |
| `detect_breakout()` | 检测压缩池中币种的突破信号（v2质量评估） | 每根K线检查时 |
| `_evaluate_breakout_quality()` | 评估突破质量（v2新增） | 突破检测时 |
| `cleanup_compression_pool()` | 清理过期或失效的压缩事件 | 定期清理时 |
| `get_strategy_details()` | 获取策略详细信息（用于调试） | 需要查看详情时 |

#### 2. `compression_scanner.py` - 压缩扫描器（生产者）

**作用**：扫描整个市场，寻找压缩事件。

**主要类**：

- **`CompressionScanner`**：压缩扫描器类

**主要函数**：

| 函数名 | 作用 | 调用时机 |
|--------|------|----------|
| `scan_market()` | 扫描整个市场，寻找压缩事件 | 每5分钟（可配置） |
| `_scan_single_symbol()` | 扫描单个币种 | 并行扫描时 |
| `_get_symbols_to_scan()` | 获取需要扫描的币种列表 | 扫描前 |
| `get_scan_stats()` | 获取扫描统计信息 | 查看统计时 |

#### 3. `breakout_watcher.py` - 突破监控器（消费者）

**作用**：监控压缩池中的币种，检测突破信号。

**主要类**：

- **`BreakoutWatcher`**：突破监控器类

**主要函数**：

| 函数名 | 作用 | 调用时机 |
|--------|------|----------|
| `watch_compression_pool()` | 监控压缩池中的所有币种 | 每根K线 |
| `register_breakout_callback()` | 注册突破信号回调函数 | 初始化时 |
| `_trigger_callbacks()` | 触发所有注册的回调函数 | 发现突破时 |
| `get_watch_stats()` | 获取监控统计信息 | 查看统计时 |

#### 4. `strategy_6_market_monitor.py` - 市场监控主程序

**作用**：主控制器，协调所有模块，管理整个系统。

**主要类**：

- **`VCBMarketMonitor`**：市场监控器主类

**主要函数**：

| 函数名 | 作用 | 调用时机 |
|--------|------|----------|
| `__init__()` | 初始化所有组件 | 程序启动时 |
| `start()` | 启动监控系统 | 用户调用时 |
| `stop()` | 停止监控系统 | 用户停止或程序退出时 |
| `run()` | 运行监控系统（阻塞） | 主程序入口 |
| `_scan_loop()` | 扫描循环（生产者线程） | 后台线程 |
| `_watch_loop()` | 监控循环（消费者线程） | 后台线程 |
| `_on_breakout()` | 突破信号回调处理 | 发现突破时 |
| `_execute_trade()` | 执行交易 | 突破回调时 |

### 辅助文件

#### 5. `methods/monitor.py` - 单币种监控（保留用于单币种模式）

**作用**：单币种监控实现（类似strategy_1，保留用于特殊场景）。

**主要类**：

- **`Strategy6Monitor`**：单币种监控器

#### 6. `methods/trader.py` - 交易执行器

**作用**：执行实际交易操作。

**主要类**：

- **`Strategy6Trader`**：交易执行器类（继承自BaseTrader）

#### 7. `methods/position_manager.py` - 仓位管理器

**作用**：实现三层平仓逻辑（硬止损、主动止盈、失败退出）。

**主要类**：

- **`PositionManager`**：仓位管理器类

**主要函数**：

| 函数名 | 作用 | 调用时机 |
|--------|------|----------|
| `calculate_stop_loss()` | 计算硬止损价格（v2使用ATR(20)） | 开仓时 |
| `calculate_take_profit()` | 计算止盈价格 | 开仓时 |
| `check_structure_validation()` | 检查结构验证（v2新增） | 每根K线检查持仓时 |
| `check_hard_stop_loss()` | 检查硬止损触发 | 每根K线检查持仓时 |
| `check_take_profit()` | 检查主动止盈触发 | 每根K线检查持仓时 |
| `check_failure_exit()` | 检查失败退出条件 | 每根K线检查持仓时 |
| `check_break_even()` | 检查Break-even条件 | 每根K线检查持仓时 |
| `is_major_coin()` | 判断是否为主流币 | 计算止盈时 |

**核心逻辑**：

1. **结构验证**（v2新增）：突破后最多允许2根K线的验证期，验证期内判断突破结构是否被否定
2. **硬止损**（v2优化）：基于压缩区间另一侧和ATR(20)兜底，取两者中更保守者
3. **主动止盈**：支持R倍止盈、布林中轨止盈、对侧轨道止盈、ATR跟踪止盈
4. **失败退出**：突破后X根K线内无法扩展波动率则平仓
5. **Break-even**：浮盈≥1R时，止损移到入场价

#### 8. `shared_config.py` - 配置管理

**作用**：管理策略配置参数。

**主要函数**：

| 函数名 | 作用 |
|--------|------|
| `load_config_from_file()` | 从JSON文件加载配置 |
| `get_user_input()` | 获取用户输入参数 |
| `print_final_config()` | 打印最终使用的参数 |

#### 9. `configs/default.json` - 默认配置文件

**作用**：存储默认配置参数。

---

## 仓位生命周期管理

### 核心思想

**入场解决"是否值得赌"，平仓解决"如何把优势变成钱"。**

平仓被拆成三层（实盘友好结构）：

### 0. 结构验证（v2新增，最高优先级）

**目的**：突破后最多允许2根K线的验证期，验证期内判断突破结构是否被否定。

**规则**：

- 验证期：突破后最多2根K线（1分钟K线 = 2分钟）
- 结构失败判定：价格回到压缩区间内部
  - 做多：`price < compression_low - 0.2 × ATR(10)`
  - 做空：`price > compression_high + 0.2 × ATR(10)`
- 处理逻辑：
  - 第1根K线失败：记录但不平仓
  - 第2根K线仍失败：立即平仓（`STRUCTURE_VALIDATION_FAIL`）

**特点**：

- 验证期内不触发硬止损，优先检查结构验证
- 防止过早止损，给突破一定的验证时间
- 一旦结构被否定，立即认错

### 1. 硬止损（结构性错误，必须走）

**目的**：一旦证明"不是压缩突破，而是噪音"，立刻认错。

**计算逻辑**（v2优化）：

- **做多**：
  ```
  SL_struct = 压缩区间最低价 - 0.2 × ATR(20)
  SL_atr    = Entry - 1.2 × ATR(20)
  SL = max(SL_struct, SL_atr)  // 取更保守者
  ```

- **做空**：
  ```
  SL_struct = 压缩区间最高价 + 0.2 × ATR(20)
  SL_atr    = Entry + 1.2 × ATR(20)
  SL = min(SL_struct, SL_atr)  // 取更保守者
  ```

**特点**（v2变化）：

- 基于压缩区间的另一侧 ± 0.2×ATR(20)
- **v2修改**：使用ATR(20)而不是ATR(60)
- **v2修改**：ATR止损倍数为1.2（而不是0.8）
- 取结构止损和ATR止损中更保守者
- 非协商式止损，不允许策略内犹豫
- **验证期外才检查**（前2根K线不触发硬止损）

### 2. 主动止盈（结构兑现）

**目的**：明确写成三种可切换模式（不是拍脑袋）。

**止盈模式**：

1. **R倍止盈**（默认）：
    - 主流币：1.5R
    - 山寨币：2.5R
    - 公式：`TP = Entry ± R × take_profit_r`

2. **布林中轨止盈**：
    - 价格回到布林中轨时平仓
    - 适合趋势延续性较好的情况

3. **对侧轨道止盈**：
    - 做多：到达布林上轨
    - 做空：到达布林下轨
    - 适合脉冲型行情

4. **ATR跟踪止盈**：
    - 当 ATR(10) > 1.5 × ATR_entry 或 ATR(10) 开始拐头下降 → 平仓
    - 适合趋势强时

**为什么VCB不追求"一次吃完趋势"**：

- VCB策略的本质是捕捉"结构性释放"，而非长期趋势
- "先兑现结构，再谈趋势"更符合统计优势
- 避免在震荡市中回吐利润

### 3. 失败退出（最容易被忽略，但很值钱）

**目的**：时间成本控制，专门处理"假突破但没打到SL的垃圾交易"。

**规则**：

- 如果突破后 X 根 K 线内无法扩展波动率 → 主动平仓
- 判断标准：`ATR_current / ATR_entry < failure_exit_atr_threshold`

**这不是止损**：

- 不是价格止损
- 是时间成本控制
- 避免持仓时间过长但无实际收益

### 4. Break-even（保本规则）

**规则**：

- 浮盈 ≥ 1R 时，止损移到入场价（或+手续费）
- 防止"对了又亏"
- 显著改善资金曲线稳定性

---

## 核心函数详解

### 1. 压缩检测流程（v2多时间框架版本）

#### `VCBStrategy.detect_compression()`

**功能**：检测单个币种是否出现波动率压缩（v2多时间框架版本）。

**执行步骤**：

**Level 1: 5分钟周期压缩检测**

1. 获取5分钟K线数据（需要足够的历史数据）
2. 计算ATR（短期和中期）
    - `ATR_short = ATR(10)`
    - `ATR_mid = ATR(60)`
3. 计算ATR比率：`atr_ratio = ATR_short / ATR_mid`
4. 检查ATR相对收缩：`atr_ratio < 0.5`（可配置）
5. 计算布林带（BB）
    - `BB(20, 2)` - 20周期，2倍标准差
6. 计算布林带宽度：`bb_width = (upper - lower) / middle`
7. 检查布林带宽度收缩：`bb_width < 0.7 × bb_width_60_mean`
8. **v2新增**：计算压缩评分（`_calculate_compression_score()`）
    - ATR相对压缩得分（默认权重30%，可配置`score_weight_atr`）
    - 压缩持续时间得分（默认权重25%，可配置`score_weight_duration`）
    - 成交量健康度得分（默认权重20%，可配置`score_weight_volume`）
    - 价格区间收敛得分（默认权重15%，可配置`score_weight_range`）
    - 均线聚合度得分（默认权重10%，可配置`score_weight_ma`）
9. **v2新增**：只有压缩评分≥`compression_score_threshold`（默认70.0）才认为是高质量压缩

**Level 2: 15分钟周期验证**（v2.1参数可配置）

10. 获取15分钟K线数据进行验证
11. **v2新增**：15分钟周期验证（`_validate_15m_compression()`）
    - 趋势方向确认：价格偏离度 < `validation_price_deviation_threshold`（默认2.0%，避免趋势过强）
    - 波动率背景确认：ATR相对水平 < `validation_atr_relative_threshold`（默认1.5%，避免波动率过高）
    - 价格结构确认：75分钟振幅 / 5小时振幅 < `validation_amplitude_ratio_threshold`（默认0.4，结构支持压缩）
12. 如果验证未通过，返回None

**创建压缩事件**（v2.1参数可配置）：

13. 如果所有条件都满足，创建压缩事件并放入压缩池
14. **v2新增**：计算突破水平和失效水平（v2.1可配置）
    - 突破水平：压缩区间边界 ± `breakout_threshold`（默认0.2%，v2.1从1%降低）
    - 失效水平：压缩区间边界 ± `breakout_invalidation_threshold`（默认3%）

**返回值**：

- `CompressionEvent`：如果检测到高质量压缩
- `None`：如果未检测到压缩或验证未通过

### 2. 突破检测流程（v2质量评估版本）

#### `VCBStrategy.detect_breakout()`

**功能**：检测压缩池中币种的突破信号（v2质量评估版本）。

**执行步骤**：

1. 检查币种是否在压缩池中
2. 获取最新1分钟K线数据（用于突破检测）
3. 计算成交量均线：`MA(Volume, 20)`
4. 检查成交量放大：`current_volume ≥ volume_multiplier × avg_volume`
5. **v2修改**：使用压缩事件的突破水平而不是布林带边界（v2.1可配置）
    - 做多：`close > breakout_up`（压缩区间最高价 × (1 + `breakout_threshold`)）
    - 做空：`close < breakout_down`（压缩区间最低价 × (1 - `breakout_threshold`)）
6. **v2新增**：评估突破质量（`_evaluate_breakout_quality()`，v2.1参数可配置）
    - 条件1：实体 ≥ `breakout_body_atr_multiplier` × ATR(14)（默认0.4）
    - 条件2：影线短（假突破过滤，影线<`breakout_shadow_ratio`×实体，默认50%，v2.1从30%放宽）
    - 条件3：成交量显著高于近期低点（>`breakout_volume_min_multiplier`×最近N根K线最低成交量，默认1.5倍）
    - 条件4：创局部新高/新低（`breakout_new_high_low_lookback`根K线内，默认10根）
    - **必须满足至少3/4个条件才认为突破质量合格**
7. 如果价格突破、成交量放大且突破质量合格，返回突破信号
8. 从压缩池中移除该币种（突破后不再监控）

**返回值**：

- `(1, details)`：做多突破信号（details包含突破质量评估结果）
- `(-1, details)`：做空突破信号（details包含突破质量评估结果）
- `(0, {})`：无突破信号

### 3. 压缩池管理

#### `VCBStrategy.cleanup_compression_pool()`

**功能**：清理过期或失效的压缩事件。

**清理条件**（v2.1可配置）：

1. **TTL过期**：压缩事件存活时间超过配置的K线数量
2. **压缩评分过低**：当前压缩评分 < `compression_score_min`（默认60.0）
   - **v2.1新增**：如果价格处于临界突破区（`pre_breakout_protection_zone`），则豁免此判定
3. **ATR比率回升**：当前ATR比率 > `atr_ratio_invalidation_threshold`（默认0.7）
   - **v2.1新增**：如果价格处于临界突破区，则豁免此判定

**v2.1临界突破保护机制**：
- 当价格进入 `[上轨 - 0.5%, 上轨]` 或 `[下轨, 下轨 + 0.5%]` 的临界区域时
- 暂时豁免"ATR比率回升"导致的失效判定
- 暂时豁免"评分下降"导致的移除操作
- **目的**：给行情一点时间去完成突破，不要在黎明前杀掉策略

**执行频率**：

- 每次市场扫描后
- 每次突破检测后

### 4. 市场扫描流程

#### `CompressionScanner.scan_market()`

**功能**：扫描整个市场，寻找压缩事件。

**执行步骤**：

1. 获取符合条件的币种列表（基于24h交易量过滤）
2. 使用线程池并行扫描所有币种
3. 对每个币种调用 `VCBStrategy.detect_compression()`
4. 收集所有新发现的压缩事件
5. 更新扫描统计信息

**并行处理**：

- 默认使用10个线程并行扫描
- 可配置 `max_workers` 参数

### 5. 突破监控流程

#### `BreakoutWatcher.watch_compression_pool()`

**功能**：监控压缩池中的所有币种，检测突破。

**执行步骤**：

1. 获取压缩池中的所有币种列表
2. 对每个币种调用 `VCBStrategy.detect_breakout()`
3. 收集所有突破信号
4. 触发回调函数（通知主控制器）
5. 更新监控统计信息

**执行频率**：

- 每根K线检查一次（1分钟K线 = 每60秒检查一次）

---

## 使用指南

### 1. 环境准备

#### 1.1 安装依赖

确保已安装所有必要的Python包：

```bash
pip install -r requirements.txt
```

#### 1.2 配置API密钥（可选）

如果需要真实交易，在项目根目录创建 `.env` 文件：

```env
OK-ACCESS-KEY=your_api_key
OK-ACCESS-SECRET=your_api_secret
OK-ACCESS-PASSPHRASE=your_passphrase
```

### 2. 配置文件

#### 2.1 默认配置

编辑 `configs/default.json`：

```json
{
  "min_vol_ccy": 10000000,        // 最小24h交易量（USDT）
  "currency": "USDT",             // 交易对货币
  "inst_type": "SWAP",            // 合约类型（SPOT/SWAP）
  "scan_interval_minutes": 5,     // 市场扫描间隔（分钟）
  "max_workers": 10,              // 并行扫描线程数
  "atr_short_period": 10,         // 短期ATR周期（5分钟K线）
  "atr_mid_period": 60,           // 中期ATR周期（5分钟K线）
  "atr_ratio_threshold": 0.5,     // ATR比率阈值
  "bb_period": 20,                // 布林带周期
  "bb_std": 2,                    // 布林带标准差倍数
  "bb_width_ratio": 0.7,          // 布林带宽度收缩比率
  "volume_period": 20,            // 成交量均线周期（1分钟K线）
  "volume_multiplier": 1.0,       // 成交量放大倍数（v2建议≥1.2）
  "ttl_bars": 30,                 // 压缩事件TTL（K线数量，5分钟K线）
  "only_major_coins": false,      // 是否只做主流币
  "trailing_stop_pct": 1.0,       // 移动止损百分比（保留，用于兼容）
  "stop_loss_atr_multiplier": 0.8, // 止损ATR倍数（v2实际使用1.2×ATR(20)）
  "take_profit_mode": "r_multiple", // 止盈模式
  "take_profit_r": 2.0,           // 止盈R倍数（默认值）
  "take_profit_r_major": 1.5,     // 主流币止盈R倍数
  "take_profit_r_alt": 2.5,       // 山寨币止盈R倍数
  "failure_exit_bars": 10,        // 失败退出K线数量（1分钟K线）
  "failure_exit_atr_threshold": 1.2, // 失败退出ATR阈值
  "break_even_r": 1.0,            // Break-even触发R倍数
  "trade": false,                 // 是否真实交易
  "trade_amount": 10.0,           // 每次交易金额（USDT）
  "trade_mode": 3,                // 交易模式（1=现货, 2=全仓, 3=逐仓）
  "leverage": 3,                  // 杠杆倍数
  
  // v2.1新增：压缩评分相关参数
  "compression_score_threshold": 70.0,      // 压缩评分阈值（创建压缩事件的最低评分）
  "compression_score_min": 60.0,           // 压缩评分最低阈值（清理时最低评分）
  "atr_ratio_invalidation_threshold": 0.7, // ATR比率失效阈值
  
  // v2.1新增：突破检测相关参数
  "breakout_threshold": 0.002,              // 突破幅度阈值（0.2%，v2.1从1%降低）
  "breakout_invalidation_threshold": 0.03,  // 失效水平阈值（3%）
  "pre_breakout_protection_zone": 0.005,    // 临界突破保护区（0.5%，防止黎明前失效）
  "breakout_body_atr_multiplier": 0.4,     // 突破实体ATR倍数
  "breakout_shadow_ratio": 0.5,             // 突破影线比率（50%，v2.1从30%放宽）
  "breakout_volume_min_multiplier": 1.5,    // 突破成交量最小倍数
  "breakout_new_high_low_lookback": 10,     // 创新高/新低回看周期
  
  // v2.1新增：15分钟验证相关参数
  "validation_price_deviation_threshold": 2.0,    // 价格偏离度阈值（%）
  "validation_atr_relative_threshold": 1.5,      // ATR相对水平阈值（%）
  "validation_amplitude_ratio_threshold": 0.4,   // 振幅比率阈值
  
  // v2.1新增：压缩评分权重（总和应为1.0）
  "score_weight_atr": 0.3,        // ATR相对压缩权重
  "score_weight_duration": 0.25,  // 压缩持续时间权重
  "score_weight_volume": 0.2,     // 成交量健康度权重
  "score_weight_range": 0.15,     // 价格区间收敛权重
  "score_weight_ma": 0.1          // 均线聚合度权重
}
```

### 3. 启动系统

#### 3.1 使用默认配置

```bash
cd /Users/zijund/Code/crypto_scanner
python strategies/strategy_6_vcb_v2/strategy_6_market_monitor.py
```

#### 3.2 使用自定义配置文件

```bash
python strategies/strategy_6_vcb_v2/strategy_6_market_monitor.py --config configs/my_config.json
```

### 4. 停止系统

按 `Ctrl+C` 停止系统，系统会：

1. 停止所有线程
2. 打印统计信息
3. 安全退出

---

## 执行流程详解

### 启动流程

```
1. 用户运行 strategy_6_market_monitor.py
   ↓
2. main() 函数执行
   ↓
3. 加载配置文件（如果有）
   ↓
4. 创建 VCBMarketMonitor 实例
   ↓
5. VCBMarketMonitor.__init__() 执行：
   - 初始化 OKXClient
   - 创建 VCBStrategy 实例（共享压缩池）
   - 创建 CompressionScanner 实例（生产者）
   - 创建 BreakoutWatcher 实例（消费者）
   - 注册突破回调函数
   - 初始化交易器（如果启用真实交易）
   ↓
6. monitor.run() 执行
   ↓
7. monitor.start() 执行：
   - 打印启动信息
   - 启动扫描线程（生产者）
   - 启动监控线程（消费者）
   ↓
8. 系统进入运行状态
```

### 运行时流程

#### 生产者线程（扫描循环）

```
_scan_loop() 开始执行
   ↓
每 scan_interval_minutes 分钟执行一次：
   ↓
1. CompressionScanner.scan_market() 执行
   ↓
2. _get_symbols_to_scan() 获取币种列表
   ↓
3. 使用线程池并行扫描：
   - 对每个币种调用 _scan_single_symbol()
   - _scan_single_symbol() 调用 VCBStrategy.detect_compression()
   ↓
4. VCBStrategy.detect_compression() 执行：
   - 获取K线数据
   - 计算ATR和布林带
   - 检查压缩条件
   - 如果满足，创建 CompressionEvent 并放入压缩池
   ↓
5. VCBStrategy.cleanup_compression_pool() 清理过期事件
   ↓
6. 等待下次扫描时间
```

#### 消费者线程（监控循环）

```
_watch_loop() 开始执行
   ↓
每根K线执行一次（1分钟K线 = 每60秒）：
   ↓
1. BreakoutWatcher.watch_compression_pool() 执行
   ↓
2. 获取压缩池中的所有币种
   ↓
3. 对每个币种调用 VCBStrategy.detect_breakout()
   ↓
4. VCBStrategy.detect_breakout() 执行：
   - 检查币种是否在压缩池中
   - 获取最新K线数据
   - 计算成交量均线
   - 检查价格突破和成交量放大
   - 如果突破，从压缩池中移除币种
   ↓
5. 如果发现突破，触发回调：
   - BreakoutWatcher._trigger_callbacks()
   - 调用 VCBMarketMonitor._on_breakout()
   ↓
6. VCBMarketMonitor._on_breakout() 执行：
   - 调用 _execute_trade()
   ↓
7. VCBMarketMonitor._execute_trade() 执行：
   - 计算止损和止盈价格
   - 记录模拟交易
   - 更新持仓信息（包含止损、止盈、ATR等）
   - 如果启用真实交易，调用 Strategy6Trader.execute_trade()
   ↓
8. VCBMarketMonitor._check_positions() 执行：
   - 检查所有持仓的平仓条件
   - 包括硬止损、主动止盈、失败退出、Break-even
   ↓
9. VCBStrategy.cleanup_compression_pool() 清理过期事件
   ↓
10. 等待下次K线时间
```

### 交易执行流程

```
突破信号触发
   ↓
_on_breakout(symbol, signal, details) 执行
   ↓
_execute_trade(symbol, signal, price, details) 执行
   ↓
1. 确定交易动作：
   - signal == 1 → "LONG_OPEN"（做多）
   - signal == -1 → "SHORT_OPEN"（做空）
   ↓
2. 计算止损和止盈价格：
   - PositionManager.calculate_stop_loss() - 计算硬止损
   - PositionManager.calculate_take_profit() - 计算止盈
   - 获取入场时的ATR值（用于失败退出检查）
   ↓
3. 更新持仓信息：
   - 如果币种已有持仓，先平仓再开新仓
   - 记录入场价格、时间、止损、止盈、ATR等
   ↓
4. 记录模拟交易日志
   ↓
5. 如果启用真实交易：
   - Strategy6Trader.execute_trade(action, symbol, price)
   - 根据action执行相应的交易操作
   ↓
6. 交易完成
```

### 持仓管理流程（平仓逻辑）

```
_watch_loop() 每根K线执行
   ↓
_check_positions() 检查所有持仓
   ↓
对每个持仓执行以下检查（按优先级）：
   ↓
0. 检查结构验证（STRUCTURE_VALIDATION_FAIL，v2新增，最高优先级）：
   - PositionManager.check_structure_validation()
   - 验证期内（前2根K线）优先检查
   - 价格回到压缩区间内部 → 结构失败
   - 第2根K线仍失败 → 立即平仓
   ↓
1. 检查硬止损（HARD_STOP_LOSS，验证期外才检查）：
   - PositionManager.check_hard_stop_loss()
   - 基于压缩区间另一侧和ATR(20)兜底（v2修改）
   - 验证期外（>2根K线）才触发
   - 一旦触发，立即平仓（非协商式）
   ↓
2. 检查Break-even（更新止损）：
   - PositionManager.check_break_even()
   - 浮盈 ≥ 1R 时，止损移到入场价
   - 更新持仓中的止损价格
   ↓
3. 检查主动止盈（TAKE_PROFIT）：
   - PositionManager.check_take_profit()
   - 根据止盈模式检查：
     * R倍止盈：价格达到目标R倍数
     * 布林中轨止盈：价格回到中轨
     * 对侧轨道止盈：价格到达对侧轨道
     * ATR跟踪止盈：ATR扩展或价格回撤
   - 如果触发，立即平仓
   ↓
4. 检查失败退出（FAILURE_EXIT）：
   - PositionManager.check_failure_exit()
   - 突破后X根K线内无法扩展波动率
   - 如果触发，立即平仓（时间成本控制）
   ↓
如果任何条件触发：
   ↓
_close_position(symbol, reason, close_price) 执行
   ↓
1. 计算平仓盈亏
   ↓
2. 记录平仓交易日志（v2新增压缩评分）
   ↓
3. 如果启用真实交易，执行平仓操作
   ↓
4. 从持仓列表中移除
```

### 停止流程

```
用户按 Ctrl+C
   ↓
KeyboardInterrupt 异常触发
   ↓
monitor.run() 的 finally 块执行
   ↓
monitor.stop() 执行：
   ↓
1. 设置 running = False
   ↓
2. 等待所有线程结束（最多等待5秒）
   ↓
3. 获取并打印统计信息：
   - CompressionScanner.get_scan_stats()
   - BreakoutWatcher.get_watch_stats()
   ↓
4. 打印最终状态：
   - 压缩池大小
   - 持仓数量
   ↓
5. 程序退出
```

---

## 配置参数说明

### 扫描参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `min_vol_ccy` | float | 10000000 | 最小24小时交易量（USDT），用于过滤低流动性币种 |
| `currency` | string | "USDT" | 交易对货币 |
| `inst_type` | string | "SWAP" | 合约类型：SPOT（现货）或SWAP（永续合约） |
| `scan_interval_minutes` | int | 5 | 市场扫描间隔（分钟） |
| `max_workers` | int | 10 | 并行扫描的最大线程数 |
| `only_major_coins` | bool | false | 是否只做主流币（true=只扫描主流币，false=扫描所有符合条件的币种） |

### 压缩检测参数

**注意**：v2使用多时间框架，压缩检测基于5分钟K线，15分钟K线用于验证。

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `atr_short_period` | int | 10 | 短期ATR周期（5分钟K线） |
| `atr_mid_period` | int | 60 | 中期ATR周期（5分钟K线） |
| `atr_ratio_threshold` | float | 0.5 | ATR比率阈值，ATR_short/ATR_mid < 此值时认为压缩 |
| `bb_period` | int | 20 | 布林带周期（5分钟K线） |
| `bb_std` | int | 2 | 布林带标准差倍数 |
| `bb_width_ratio` | float | 0.7 | 布林带宽度收缩比率 |
| `ttl_bars` | int | 30 | 压缩事件TTL（5分钟K线数量），超过此数量未突破则失效 |

**v2新增**：压缩评分系统（v2.1可配置）
- 只有压缩评分≥`compression_score_threshold`的压缩事件才会被放入压缩池（默认70.0）
- 评分维度（可配置权重）：
  - ATR相对压缩（默认30%）
  - 压缩持续时间（默认25%）
  - 成交量健康度（默认20%）
  - 价格区间收敛（默认15%）
  - 均线聚合度（默认10%）

**v2.1新增参数**：

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `compression_score_threshold` | float | 70.0 | 压缩评分阈值，只有评分≥此值才创建压缩事件 |
| `compression_score_min` | float | 60.0 | 压缩评分最低阈值，低于此值将被移除（除非在临界突破区） |
| `atr_ratio_invalidation_threshold` | float | 0.7 | ATR比率失效阈值，高于此值认为压缩失效 |
| `score_weight_atr` | float | 0.3 | 压缩评分ATR权重 |
| `score_weight_duration` | float | 0.25 | 压缩评分持续时间权重 |
| `score_weight_volume` | float | 0.2 | 压缩评分成交量权重 |
| `score_weight_range` | float | 0.15 | 压缩评分价格区间权重 |
| `score_weight_ma` | float | 0.1 | 压缩评分均线权重 |

**v2.1新增**：15分钟验证参数（可配置）

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `validation_price_deviation_threshold` | float | 2.0 | 15分钟验证价格偏离度阈值（%），价格偏离度<此值才通过验证 |
| `validation_atr_relative_threshold` | float | 1.5 | 15分钟验证ATR相对水平阈值（%），ATR相对水平<此值才通过验证 |
| `validation_amplitude_ratio_threshold` | float | 0.4 | 15分钟验证振幅比率阈值，振幅比率<此值才通过验证 |

### 突破检测参数

**注意**：v2突破检测基于1分钟K线，用于精确捕捉突破时机。

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `volume_period` | int | 20 | 成交量均线周期（1分钟K线） |
| `volume_multiplier` | float | 1.0 | 成交量放大倍数，当前成交量 ≥ 此值 × 均量时认为放量（v2建议≥1.2） |

**v2新增**：突破质量评估（v2.1可配置）
- 突破K线必须满足至少3/4个条件：
  1. 实体 ≥ `breakout_body_atr_multiplier` × ATR(14)（默认0.4）
  2. 影线短（假突破过滤，影线<`breakout_shadow_ratio`×实体，默认50%，v2.1从30%放宽）
  3. 成交量显著高于近期低点（>`breakout_volume_min_multiplier`×最近N根K线最低成交量，默认1.5倍）
  4. 创局部新高/新低（`breakout_new_high_low_lookback`根K线内，默认10根）

**v2.1新增参数**：

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `breakout_threshold` | float | 0.002 | 突破幅度阈值（0.2%，v2.1从1%降低，防止踏空） |
| `breakout_invalidation_threshold` | float | 0.03 | 失效水平阈值（3%，压缩区间边界±此值） |
| `pre_breakout_protection_zone` | float | 0.005 | 临界突破保护区（0.5%，价格在此范围内时豁免失效判定，防止黎明前失效） |
| `breakout_body_atr_multiplier` | float | 0.4 | 突破实体ATR倍数，实体≥此值×ATR(14) |
| `breakout_shadow_ratio` | float | 0.5 | 突破影线比率（50%，影线<此值×实体） |
| `breakout_volume_min_multiplier` | float | 1.5 | 突破成交量最小倍数，成交量>此值×近期最低成交量 |
| `breakout_new_high_low_lookback` | int | 10 | 创新高/新低回看周期（K线数量） |

### 风险管理参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `trailing_stop_pct` | float | 1.0 | 移动止损百分比（保留，用于兼容） |
| `stop_loss_atr_multiplier` | float | 0.8 | 止损ATR倍数（v2修改：1.2 × ATR(20)，硬止损的ATR兜底） |
| `structure_stop_atr_multiplier` | float | 0.2 | 结构止损ATR倍数（v2新增：压缩区间反侧 ± 0.2×ATR） |
| `take_profit_mode` | string | "r_multiple" | 止盈模式：r_multiple（R倍）、bb_middle（布林中轨）、bb_opposite（对侧轨道）、atr_trailing（ATR跟踪） |
| `take_profit_r` | float | 2.0 | 止盈R倍数（默认值） |
| `take_profit_r_major` | float | 1.5 | 主流币止盈R倍数 |
| `take_profit_r_alt` | float | 2.5 | 山寨币止盈R倍数 |
| `failure_exit_bars` | int | 10 | 失败退出K线数量（1分钟K线，突破后X根K线内无法扩展波动率则平仓） |
| `failure_exit_atr_threshold` | float | 1.2 | 失败退出ATR阈值（突破后ATR需扩展到此倍数，否则平仓） |
| `break_even_r` | float | 1.0 | Break-even触发R倍数（浮盈≥此值时，止损移到入场价） |

**v2新增**：结构验证机制
- 突破后最多允许2根K线（1分钟K线 = 2分钟）的验证期
- 验证期内判断突破结构是否被否定
- 结构失败判定：价格回到压缩区间内部

### 交易参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `trade` | bool | false | 是否启用真实交易 |
| `trade_amount` | float | 10.0 | 每次交易金额（USDT） |
| `trade_mode` | int | 3 | 交易模式：1=现货，2=全仓杠杆，3=逐仓杠杆 |
| `leverage` | int | 3 | 杠杆倍数（仅杠杆模式有效） |

---

## V2.0/V2.1 版本改进总结

### V2.0 核心改进目标

V2.0 的核心目标是**降低假突破率、减少过度交易、提升胜率至45%+**。

### V2.0 主要改进点

1. **多时间框架压缩检测**
   - Level 1（5分钟）：主压缩识别
   - Level 2（15分钟）：背景验证（趋势强度、波动率背景、价格结构）
   - Level 3（1分钟）：入场与执行

2. **压缩评分系统**
   - 引入0-100分的压缩评分
   - 只交易评分≥70的高质量压缩
   - 评分维度：ATR相对压缩(30%)、压缩持续时间(25%)、成交量健康度(20%)、价格区间收敛(15%)、均线聚合度(10%)

3. **突破质量评估**
   - 突破K线必须满足至少3/4个条件
   - 过滤假突破，提升信号质量

4. **结构验证机制**
   - 突破后最多允许2根K线的验证期
   - 验证期内判断突破结构是否被否定
   - 防止过早止损

5. **止损逻辑优化**
   - 使用ATR(20)而不是ATR(60)
   - 结构止损：压缩区间反侧 ± 0.2×ATR
   - ATR止损：1.2 × ATR(20)
   - 取两者中更保守者

### V2.1 核心改进（参数校准与逻辑修复）

V2.1 针对 V2.0 实盘反馈的"死板参数"问题进行了紧急修复：

1. **突破阈值降低**
   - 突破幅度从1%降低到0.2%（`breakout_threshold`）
   - 防止还没触发开单系统就判定压缩结束

2. **临界突破保护机制**
   - 新增`pre_breakout_protection_zone`参数（默认0.5%）
   - 当价格进入临界突破区时，豁免评分下降和ATR比率回升导致的失效判定
   - 防止"倒在黎明前"的漏单问题

3. **突破质量评估参数放宽**
   - 影线控制阈值从30%放宽到50%（`breakout_shadow_ratio`）
   - 允许温和放量启动（`breakout_volume_min_multiplier`默认1.5倍）

4. **所有关键参数可配置**
   - 压缩评分阈值、权重全部可配置
   - 15分钟验证参数可配置
   - 突破检测参数可配置
   - 便于根据实盘反馈快速调整

### 预期效果

| 指标 | V1.0 | V2.0 目标 | V2.1 改进 |
|------|------|----------|----------|
| 胜率 | ~30% | 45%+ | 提升信号捕捉灵敏度 |
| 假突破率 | 高 | 明显下降 | 进一步降低 |
| 交易频率 | 过高 | ↓ 50% | 保持低频高质量 |
| 单日最大亏损 | 20% | <5% | 保持 |
| 漏单问题 | - | - | 显著改善 |

---

## 常见问题

### Q1: 系统启动后没有发现压缩事件？

**可能原因**：

1. 市场当前没有符合条件的压缩
2. `min_vol_ccy` 设置过高，过滤掉了太多币种
3. `atr_ratio_threshold` 设置过严格

**解决方法**：

- 降低 `min_vol_ccy` 值
- 适当放宽 `atr_ratio_threshold`（如改为0.6）
- 等待市场出现压缩机会

### Q2: 发现压缩但没有突破？

**可能原因**：

1. 压缩事件TTL过期
2. ATR比率回升，压缩失效
3. 突破条件未满足（价格未突破或成交量未放大）

**解决方法**：

- 检查 `ttl_bars` 设置是否合理
- 检查 `volume_multiplier` 是否过严格
- 查看日志了解具体原因

### Q3: 如何调整扫描频率？

修改配置文件中的 `scan_interval_minutes` 参数：

- 更频繁扫描：设置为 3（每3分钟扫描一次）
- 更少扫描：设置为 10（每10分钟扫描一次）

注意：过于频繁的扫描可能触发API限流。

### Q4: 如何查看当前压缩池状态？

系统会定期打印状态信息，包括：

- 压缩池大小
- 压缩池中的币种列表
- 当前持仓数量

### Q5: 真实交易如何启用？

1. 在 `.env` 文件中配置API密钥
2. 在配置文件中设置 `"trade": true`
3. 配置交易参数（`trade_amount`, `trade_mode`, `leverage`）

**⚠️ 警告**：启用真实交易前请充分测试，确保策略逻辑正确！

### Q6: 如何优化策略参数？

建议步骤：

1. 使用模拟交易模式测试不同参数组合
2. 记录每次交易的收益和风险
3. 分析参数对策略表现的影响
4. 选择最优参数组合后再启用真实交易

### Q7: 系统占用资源过多？

**优化建议**：

1. 降低 `max_workers`（减少并行线程数）
2. 增加 `scan_interval_minutes`（减少扫描频率）
3. 提高 `min_vol_ccy`（减少扫描的币种数量）

### Q8: 如何处理网络错误？

系统已内置错误处理：

- 网络错误时会自动重试
- 单个币种扫描失败不会影响整体运行
- 建议保持稳定的网络连接

### Q9: 如何选择止盈模式？

**推荐配置**：

- **主流币（BTC, ETH等）**：
    - 模式：`r_multiple` 或 `atr_trailing`
    - R倍数：1.5R（趋势延展较好）

- **山寨币**：
    - 模式：`r_multiple` 或 `bb_opposite`
    - R倍数：2.5R（脉冲型为主）

**切换方法**：
在配置文件中修改 `take_profit_mode` 参数。

### Q10: 失败退出参数如何设置？

**推荐配置**：

- `failure_exit_bars`: 10（1分钟K线 = 10分钟）
- `failure_exit_atr_threshold`: 1.2（ATR需扩展20%）

**调整建议**：

- 如果假突破较多：降低 `failure_exit_bars`（如改为5）
- 如果过早退出：提高 `failure_exit_atr_threshold`（如改为1.5）

### Q11: 主流币过滤如何使用？

**使用场景**：

- 只做主流币：设置 `"only_major_coins": true`
- 扫描所有币种：设置 `"only_major_coins": false`（默认）

**主流币列表**：
BTC, ETH, BNB, SOL, XRP, ADA, DOGE, AVAX, TON, TRX, DOT, MATIC, LTC, BCH

**优势**：

- 减少扫描币种数量，提高效率
- 主流币流动性更好，滑点更小
- 适合保守型交易者

### Q12: 平仓逻辑的执行顺序是什么？

**执行顺序**（按优先级，v2更新）：

0. **结构验证**（v2新增，最高优先级）- 验证期内（前2根K线）优先检查，结构失败立即平仓
1. **硬止损**（验证期外才检查）- 一旦触发立即平仓
2. **Break-even**（更新止损）- 不触发平仓，只更新止损价格
3. **主动止盈** - 根据止盈模式检查
4. **失败退出** - 时间成本控制

**注意**：每个持仓每根K线都会按此顺序检查，一旦触发平仓条件，立即执行。验证期内不触发硬止损，优先检查结构验证。

### Q13: 如何理解"硬止损"、"结构验证"和"失败退出"的区别？

**结构验证**（v2新增）：

- 基于价格和时间（验证期内）
- 突破后前2根K线的验证期
- 判断突破结构是否被否定
- 第2根K线仍失败 → 立即平仓

**硬止损**（v2优化）：

- 基于价格（验证期外）
- 证明"不是压缩突破，而是噪音"
- 使用ATR(20)而不是ATR(60)
- 验证期外（>2根K线）才触发
- 立即认错，保护资金

**失败退出**：

- 基于时间和波动率
- 处理"假突破但没打到SL的垃圾交易"
- 时间成本控制，避免持仓时间过长

**举例**：

- 结构验证：突破后第1根K线，价格回到压缩区间内 → 记录但不平仓；第2根K线仍失败 → 立即平仓
- 硬止损：验证期外，价格回到压缩区间内 → 立即平仓
- 失败退出：突破后10根K线，ATR没有扩展 → 平仓

### Q14: V2.1新增的参数如何调整？

**压缩评分相关**：

- `compression_score_threshold`（默认70.0）：
  - 提高：更严格，只交易最高质量压缩（建议75-80）
  - 降低：更宽松，交易更多压缩机会（建议65-70）
  
- `compression_score_min`（默认60.0）：
  - 提高：更早清理低质量压缩（建议65）
  - 降低：保留更多压缩事件（建议55）

**突破检测相关**：

- `breakout_threshold`（默认0.002，即0.2%）：
  - **v2.1核心修改**：从1%降低到0.2%，防止踏空
  - 提高：更严格的突破确认（建议0.003-0.005）
  - 降低：更早捕捉突破（建议0.001-0.002）

- `pre_breakout_protection_zone`（默认0.005，即0.5%）：
  - **v2.1核心功能**：防止黎明前失效
  - 提高：更大的保护范围（建议0.01，即1%）
  - 降低：更小的保护范围（建议0.003，即0.3%）

- `breakout_shadow_ratio`（默认0.5，即50%）：
  - **v2.1修改**：从30%放宽到50%
  - 提高：更严格的影线控制（建议0.3-0.4）
  - 降低：更宽松的影线控制（建议0.5-0.6）

**15分钟验证相关**：

- `validation_price_deviation_threshold`（默认2.0%）：
  - 提高：允许更强的趋势（建议2.5-3.0%）
  - 降低：更严格的趋势过滤（建议1.5-2.0%）

- `validation_amplitude_ratio_threshold`（默认0.4）：
  - 提高：允许更大的振幅（建议0.5-0.6）
  - 降低：更严格的结构要求（建议0.3-0.4）

### Q15: 如何根据市场情况调整参数？

**震荡市场**：

- 提高`compression_score_threshold`（75-80）
- 提高`breakout_threshold`（0.003-0.005）
- 降低`pre_breakout_protection_zone`（0.003）

**趋势市场**：

- 降低`compression_score_threshold`（65-70）
- 降低`breakout_threshold`（0.001-0.002）
- 提高`validation_price_deviation_threshold`（2.5-3.0%）

**高波动市场**：

- 提高`breakout_shadow_ratio`（0.5-0.6）
- 提高`validation_atr_relative_threshold`（1.8-2.0%）
- 提高`breakout_volume_min_multiplier`（1.8-2.0）

**低波动市场**：

- 降低`breakout_shadow_ratio`（0.3-0.4）
- 降低`validation_atr_relative_threshold`（1.2-1.5%）
- 降低`breakout_volume_min_multiplier`（1.2-1.5）

---

## 日志说明

### 日志级别

- **INFO**：正常信息（扫描结果、突破信号等）
- **WARNING**：警告信息（单个币种扫描失败等）
- **ERROR**：错误信息（严重错误，需要关注）

### 关键日志示例

```
✅ 发现压缩: BTC-USDT (ATR比率=0.4234, 压缩评分=75.2)
BTC-USDT 15分钟周期验证通过: {'validation_passed': True, 'support_score': 85, ...}
🚀 突破信号: BTC-USDT 做多 价格=45000.0000, 成交量比率=1.85, 压缩评分=75.2, 突破质量得分=3/4
📊 BTC-USDT 开仓: 入场=45000.0000, 止损=44800.0000, 止盈=45300.0000
[模拟交易] BTC-USDT LONG_OPEN: 价格=45000.0000
🔄 BTC-USDT Break-even触发: 止损更新为 45000.0000
🔴 BTC-USDT 平仓 [TAKE_PROFIT_R]: 入场=45000.0000, 平仓=45300.0000, 收益率=0.67%, 盈亏=2.00 USDT
[状态] 压缩池: 5 个币种, 持仓: 2 个
```

---

## 技术支持

如有问题，请检查：

1. 日志文件中的错误信息
2. 配置文件是否正确
3. API密钥是否有效（真实交易模式）
4. 网络连接是否正常

---

---

## 附录

### A. 主流币列表

系统定义的主流币列表（用于 `only_major_coins` 过滤）：

```python
MAJOR_COINS = [
    'BTC', 'ETH', 'BNB', 'SOL', 'XRP', 'ADA', 'DOGE',
    'AVAX', 'TON', 'TRX', 'DOT', 'MATIC', 'LTC', 'BCH'
]
```

### B. 止盈模式详解

#### R倍止盈（r_multiple）

- **公式**：`TP = Entry ± R × take_profit_r`
- **R计算**：`R = |Entry - StopLoss|`
- **适用场景**：通用，适合大多数情况

#### 布林中轨止盈（bb_middle）

- **逻辑**：价格回到布林中轨时平仓
- **适用场景**：趋势延续性较好的主流币

#### 对侧轨道止盈（bb_opposite）

- **逻辑**：
    - 做多：价格到达布林上轨
    - 做空：价格到达布林下轨
- **适用场景**：脉冲型行情，山寨币

#### ATR跟踪止盈（atr_trailing）

- **逻辑**：
    - 当 ATR(10) > 1.5 × ATR_entry 时平仓
    - 或 ATR(10) 开始拐头下降时平仓
- **适用场景**：趋势强时，主流币

### C. 平仓原因代码

系统使用以下代码标识平仓原因：

| 代码 | 说明 |
|------|------|
| `STRUCTURE_VALIDATION_FAIL` | 结构验证失败（v2新增） |
| `HARD_STOP_LOSS` | 硬止损触发 |
| `TAKE_PROFIT_R` | R倍止盈触发 |
| `TAKE_PROFIT_BB_MIDDLE` | 布林中轨止盈触发 |
| `TAKE_PROFIT_BB_OPPOSITE` | 对侧轨道止盈触发 |
| `TAKE_PROFIT_ATR_TRAILING` | ATR跟踪止盈触发 |
| `FAILURE_EXIT` | 失败退出（时间成本控制） |

### D. 配置参数完整列表

完整的配置参数说明请参考 [配置参数说明](#配置参数说明) 章节。

---

**版本**：2.1  
**最后更新**：2025年  
**作者**：Zijun Deng  
**更新内容**：

- **V2.0核心改进**：
  - 多时间框架压缩检测（5分钟+15分钟验证）
  - 压缩评分系统（只交易评分≥70的高质量压缩）
  - 突破质量评估（必须满足至少3/4个条件）
  - 结构验证机制（突破后2根K线验证期）
  - 止损逻辑优化（使用ATR(20)而不是ATR(60)）
- **V2.1核心改进**：
  - 突破阈值降低（从1%到0.2%，防止踏空）
  - 临界突破保护机制（防止黎明前失效）
  - 突破质量评估参数放宽（影线阈值从30%到50%）
  - 所有关键参数可配置（便于快速调整）
- 新增仓位生命周期管理章节
- 新增三层平仓逻辑说明（结构验证、硬止损、主动止盈、失败退出）
- 新增主流币过滤功能说明
- 新增Break-even规则说明
- 完善持仓管理流程文档
- 交易记录新增压缩评分字段
- 新增V2.1参数配置说明

