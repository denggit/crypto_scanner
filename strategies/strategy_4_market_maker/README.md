# OKX 自动高频做市策略系统开发文档

## 一、项目概述

本系统基于 **OKX API**，实现自动化的单币高频做市策略。  
核心目标是：在 **买一卖一价差 0.08%~0.15%** 区间内，自动捕捉短线价差，通过高频挂单与撤单实现稳定收益。  
策略核心思想为 **低风险、低持仓、微利高频复利**。

---

## 二、系统总体架构

```text
+-----------------------------------------------------------+
|                         系统架构                          |
+-----------------------------------------------------------+
|  用户配置层  | 参数管理、币种选择、策略阈值设定          |
|--------------+--------------------------------------------|
|  数据层      | 实时盘口数据、订单簿、成交记录             |
|--------------+--------------------------------------------|
|  策略引擎层  | 价差监控、挂单逻辑、反向单逻辑、风险控制   |
|--------------+--------------------------------------------|
|  执行层      | OKX API 接口（REST + WebSocket）           |
|--------------+--------------------------------------------|
|  日志监控层  | 成交日志、撤单日志、异常告警               |
+-----------------------------------------------------------+
```

---

## 三、策略流程图

```mermaid
flowchart TD
A[启动策略] --> B[订阅OKX盘口数据]
B --> C[计算买一/卖一价差]
C --> D{价差 >= 最小阈值?}
D -- 否 --> B
D -- 是 --> E[检查是否已有挂单]
E -- 有 --> F[判断成交状态]
F -- 买单成交? --> G[撤销卖单]
G --> H{卖一价差 >= 二次挂单阈值?}
H -- 是 --> I[挂反向卖单(止盈)]
H -- 否 --> J[暂不挂单,等待]
F -- 卖单成交? --> K[撤销买单并反向挂单]
F -- 都未成交 --> B
I --> B
J --> B
K --> B
```

---

## 四、策略逻辑说明

### 1. 初始挂单逻辑

当 `(卖一价 - 买一价) / 买一价 >= 最小价差阈值` 时：
- 在 **买一价** 挂买单（Maker）
- 在 **卖一价** 挂卖单（Maker）
- 单笔下单金额 ≤ 总资金 5%
- 同时挂单总额 ≤ 总资金 25%

### 2. 成交逻辑

**买单成交时：**
1. 撤销原卖单；
2. 检查当前价差是否 ≥ 二次挂单阈值（如 0.08%）；
3. 若满足，则立刻在新卖一价重新挂卖单；
4. 若不满足，暂时持币等待价差恢复。

**卖单成交时：**
1. 撤销买单；
2. 检查价差是否满足重新买入条件；
3. 若满足则挂新买单，否则等待。

### 3. 撤单逻辑
- 若盘口变动超过阈值（例如买一价上移 > 0.05%），立即撤单并重挂；
- 若 5 秒内未成交，则撤单重挂；
- 若连续3次成交亏损，则暂停交易 5 分钟。

---

## 五、风险控制

| 风控项 | 说明 |
|--------|------|
| 最大单笔仓位 | 不超过总资金的 5% |
| 最大挂单总额 | 不超过总资金的 25% |
| 撤单频率 | 每 2 秒刷新盘口，挂单至少保留 3 秒 |
| 连续亏损 | 连续3笔亏损暂停5分钟 |
| 杠杆限制 | 永续合约杠杆 ≤ 10x |
| 止损条件 | 浮亏超过单笔0.2%即市价止损 |
| 最低流动性要求 | 盘口买卖一深度 ≥ 资金量 3 倍 |

---

## 六、参数配置

| 参数名 | 默认值 | 说明 |
|--------|---------|------|
| `symbol` | `BTC-USDT` | 交易对 |
| `min_spread` | `0.001` | 最小挂单价差(0.1%) |
| `reentry_spread` | `0.0008` | 重新挂单最小价差(0.08%) |
| `order_amount` | `5` | 每笔下单金额(USDT) |
| `max_open_orders` | `5` | 最大同时挂单数 |
| `leverage` | `1` | 杠杆倍数（现货=1） |
| `cancel_delay` | `3s` | 撤单延迟 |
| `risk_pause` | `5m` | 连续亏损暂停时间 |
| `api_latency_limit` | `200ms` | 允许最大API延迟 |
| `maker_fee` | `0.0002` | 挂单费率(0.02%) |
| `taker_fee` | `0.0005` | 吃单费率(0.05%) |

---

## 七、执行层接口交互

### 主要 API

| 功能 | 接口 | 方法 |
|------|------|------|
| 获取盘口 | `/api/v5/market/books` | GET |
| 下单 | `/api/v5/trade/order` | POST |
| 撤单 | `/api/v5/trade/cancel-order` | POST |
| 查询订单 | `/api/v5/trade/order` | GET |
| WebSocket订阅 | `wss://ws.okx.com:8443/ws/v5/public` | SUB |

### 示例：WebSocket 订阅
```json
{
  "op": "subscribe",
  "args": [
    {
      "channel": "books5",
      "instId": "BTC-USDT"
    }
  ]
}
```

---

## 八、日志与监控系统

| 类型 | 示例内容 |
|------|-----------|
| 订单日志 | `2025-11-03 12:00:01 买单成交 10000USDT @ 101.2` |
| 撤单日志 | `2025-11-03 12:00:02 撤单成功 order_id=1234` |
| 告警日志 | `价差不足0.08%，暂停挂单` |
| 系统监控 | `API延迟 150ms 正常` |

监控模块包括：
- API响应时间；
- 挂单撤单成功率；
- 连续亏损检测；
- 自动断连重连机制；
- Telegram / Email 告警推送。

---

## 九、项目目录结构

```text
okx_market_maker/
├── config/
│   └── settings.yaml           # 参数配置
├── core/
│   ├── data_feed.py            # WebSocket 数据订阅与盘口更新
│   ├── strategy_engine.py      # 核心策略逻辑
│   ├── order_manager.py        # 挂单、撤单控制
│   └── risk_control.py         # 风控与仓位管理
├── api/
│   └── okx_client.py           # OKX API 封装
├── utils/
│   └── notifier.py             # 通知与告警
├── main.py                     # 主程序入口
└── README.md
```

---

## 十、运行流程（示例）

1. 启动主程序  
   ```bash
   python main.py
   ```

2. 初始化配置  
   - 读取 `settings.yaml`  
   - 校验 API Key  
   - 建立 WebSocket 实时连接  

3. 策略循环逻辑  
   - 计算当前买一卖一价差  
   - 若价差 ≥ 0.1%，挂买卖单  
   - 监控成交  
   - 成交后立即执行反向单逻辑  
   - 若价差缩小或盘口剧烈波动，则撤单  

4. 监控与日志  
   - 每次成交记录写入日志  
   - 定时检测API延迟与余额  
   - 异常时自动告警  

---

## 十一、扩展方向

1. **动态价差调整**：根据币种波动率自动放宽或收紧价差阈值。  
2. **多币种并行引擎**：共享资金池、独立策略执行线程。  
3. **滑点预测模型**：根据盘口厚度预测成交滑点。  
4. **深度感知调仓**：利用盘口买卖力量判断方向性偏差。  
5. **量化监控面板**：提供实时收益、资金利用率、订单状态可视化。

---

## 十二、总结

该策略属于“微利高频 + 严控风控”的做市策略。  
重点不在预测价格，而在**捕捉确定性的价差机会**。  
成功的关键：
- 高频但理性撤单；
- 延迟控制在 200ms 内；
- 严格执行仓位与止损策略；
- 保持稳定的资金曲线。

当系统成熟后，可扩展为多币种永续合约做市系统，实现全天候自动套利。

---

## 示例配置文件（settings.yaml）

```yaml
symbol: BTC-USDT
order_amount: 5
min_spread: 0.001
reentry_spread: 0.0008
max_open_orders: 5
leverage: 1
cancel_delay: 3
risk_pause: 300
maker_fee: 0.0002
taker_fee: 0.0005
api_latency_limit: 200
log_level: INFO
telegram_alerts: true
```
