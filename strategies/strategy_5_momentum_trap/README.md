# 日内动量 + 流动性陷阱识别交易系统 - 完整开发文档 V1.1

## 1. 目录

1. 项目概述

   * 1.1 项目背景
   * 1.2 项目目标
   * 1.3 范围
   * 1.4 受众群体
   * 1.5 关键术语与缩略语
2. 功能需求

   * 2.1 功能列表
   * 2.2 功能描述

     * 2.2.1 数据采集
     * 2.2.2 信号识别
     * 2.2.3 探针挂单执行
     * 2.2.4 部分成交确认与撤单
     * 2.2.5 止盈止损管理
     * 2.2.6 风控监控
     * 2.2.7 日志与监控
     * 2.2.8 回测功能
3. 非功能需求
4. 系统架构设计

   * 4.1 模块划分及职责
   * 4.2 设计模式
   * 4.3 技术选型与第三方依赖
5. 数据设计
6. 接口设计
7. 部署与运维
8. 附录

---

## 2. 项目概述

### 2.1 项目背景

随着数字货币市场高频交易的兴起，短期波动中蕴含利润机会。本系统基于日内动量与流动性陷阱识别，旨在提供单市场交易策略的自动化执行能力，提升盈利效率，同时降低因假突破和流动性陷阱造成的风险。

### 2.2 项目目标

* 捕捉短期动量机会，实现单笔盈利覆盖手续费
* 避免流动性陷阱造成的亏损
* 提供实时监控、日志记录和回测功能
* 模块化设计，支持后续扩展其他币种或策略

### 2.3 范围

* 包含：盘口数据采集、信号识别、挂单执行、止盈止损、风控、日志记录、回测
* 不包含：跨市场套利、衍生品交易

### 2.4 受众群体

* 自动交易系统开发工程师
* 风险管理和量化交易研究员
* 交易策略回测团队

### 2.5 关键术语与缩略语

* bid/ask：买/卖盘口价格及深度
* maker：挂单提供流动性
* taker：主动吃单消耗流动性
* spread：ask1 - bid1
* TP/SL：止盈/止损

---

## 3. 功能需求

### 3.1 功能列表

1. 数据采集
2. 信号识别
3. 探针挂单执行
4. 部分成交确认与撤单
5. 止盈止损管理
6. 风控监控
7. 日志与监控
8. 回测功能

### 3.2 功能描述

#### 3.2.1 数据采集

* 输入：OKX WebSocket盘口数据、成交数据、历史K线数据
* 处理：解析数据、计算总深度、平均深度、成交量增速
* 输出：DepthData, TradeData

#### 3.2.2 信号识别

* 输入：DepthData, TradeData
* 处理：动量判定 + 流动性陷阱检测（含 trap_detected 实现）
* 输出：Signal(type, confidence, evidence)

#### trap_detected 逻辑摘要

流动性陷阱检测包含多个维度：深度成交方向冲突、撤单速率异常、挂单抖动、虚假挂墙、瞬时深度坍塌、价格动量背离等。通过参数化阈值和权重评分机制，输出 `is_trap` 与 `diagnostics`，后者用于日志与可视化监控。

主要检测项：

* Depth-Trade Mismatch（盘口方向与成交方向相反）
* High Cancel Rate（撤单速率异常）
* Flicker Orders（挂撤频繁）
* Fake Wall（虚假挂墙）
* Liquidity Vacuum（瞬时流动性消失）
* Price Divergence（价格与成交量背离）

若加权得分 >= trap_score_threshold，则认为检测到陷阱。

---

#### 3.2.3 探针挂单执行

* 输入：Signal, 总挂单金额
* 处理：按信号方向挂近盘口的探针单，以测试真实成交活跃度
* 输出：Order对象

#### 3.2.4 部分成交确认与撤单

* 检查订单成交比例，未成交部分超时撤单

#### 3.2.5 止盈止损管理

* 止盈挂Maker单，止损挂触发市价单

#### 3.2.6 风控监控

* 限制单笔风险与最大持仓
* 检测连续亏损暂停交易

#### 3.2.7 日志与监控

* 实时记录信号、成交、风控触发、PNL变化

#### 3.2.8 回测功能

* 使用历史盘口与成交数据模拟执行路径，输出胜率与收益分布。

---

## 4. 非功能需求

* 延迟 <50ms
* 模块化、可扩展
* API密钥加密
* 自动重连、错误回滚

---

## 5. 系统架构设计

### 5.1 模块划分

* 数据层：数据订阅、缓存、统计
* 策略层：信号识别、陷阱检测
* 执行层：下单、撤单、成交处理
* 风控层：风险限制与暂停控制
* 日志层：全局监控与可视化

### 5.2 技术选型

* Python 3.10+
* OKX SDK
* asyncio / websockets
* pandas / numpy
* sqlite3 / postgresql

---

## 6. 数据设计

定义核心结构体：DepthData、TradeData、Order、Signal、PNLLog。

---

## 7. 接口设计

模块间交互：

* 数据层 → 策略层：DepthData, TradeData
* 策略层 → 执行层：Signal, Order
* 执行层 → 风控层：Order状态、持仓数据
* 风控层 → 执行层：挂单限制、撤单指令
* 日志层 → 全模块：记录信号、订单、成交、PNL

外部接口：

* WebSocket订阅盘口和成交
* REST接口挂单、撤单、查询订单状态
* 错误处理机制：异常捕获、重试、报警通知

---

## 8. 部署与运维

* 部署架构：本地服务器或云服务器均可部署，支持多线程与异步运行。

- CI/CD：实现代码自动化测试、打包与部署脚本执行。

* 系统监控：日志实时上传，异常错误通过邮件、钉钉或 Slack 报警。

- 备份与恢复：数据库每日自动备份，关键配置文件采用加密存储机制。

---

## 9. 附录

### 9.1 参考资料

* OKX 官方文档
* Python SDK 文档
* 相关量化交易论文

### 9.2 术语表

| 术语     | 含义               |
| ------ | ---------------- |
| bid    | 买价盘口             |
| ask    | 卖价盘口             |
| maker  | 提供流动性的挂单方        |
| taker  | 消耗流动性的吃单方        |
| spread | 盘口差（ask1 - bid1） |
| TP     | 止盈点位             |
| SL     | 止损点位             |

### 9.3 历史版本记录

* V1.0 初稿
* V1.1 完善 trap_detected 函数逻辑
